---

- hosts: cindy
  vars_files:
    - vars/base.yml
    - vars/test.yml
    - vars/packages.yml
  become: yes

  tasks:
  - include: maykin-deployment/ansible/tasks/startdeploy.yml
  - block:
    - include: maykin-deployment/ansible/tasks/create_maykin_user.yml
    - include: maykin-deployment/ansible/tasks/staff_pub_keys.yml
    - include: maykin-deployment/ansible/tasks/setup.yml
    - include: maykin-deployment/ansible/tasks/hostname.yml
    - include: maykin-deployment/ansible/tasks/exim4.yml
    - include: maykin-deployment/ansible/tasks/firewall.yml
    - include: maykin-deployment/ansible/tasks/zabbix-agent.yml
    - include: maykin-deployment/ansible/tasks/logrotate.yml
    - include: maykin-deployment/ansible/tasks/postgresql-11-postgis-2.5.yml
    - include: maykin-deployment/ansible/tasks/npm.yml
    - include: maykin-deployment/ansible/tasks/set-maintenance-mode.yml
    - include: tasks/django-project.yml
    - include: maykin-deployment/ansible/tasks/nginx-per-target.yml
    - include: maykin-deployment/ansible/tasks/cronjobs.yml
    - include: maykin-deployment/ansible/tasks/rsnapshot.yml
    - include: maykin-deployment/ansible/tasks/supervisor-per-group.yml
    - include: maykin-deployment/ansible/tasks/unset-maintenance-mode.yml
    - include: maykin-deployment/ansible/tasks/stopdeploy.yml
    rescue:
    - include: maykin-deployment/ansible/tasks/errordeploy.yml

  handlers:
  - include: maykin-deployment/ansible/handlers/main.yml
